# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

---

name: Pre-Merge CI Pipeline

on:
  pull_request:
    branches:
      - main
      - release-*
  workflow_dispatch: 

jobs:
  pre-merge:
    uses: open-edge-platform/orch-ci/.github/workflows/pre-merge.yml@main
    with:
      run_security_scans: true
      run_version_check: true
      run_dep_version_check: true
      cache_go: true
      run_build: true
      run_lint: true
      run_test: true
      run_validate_clean_folder: false
      remove_cache_go: true
      run_docker_build: true
      run_scan_containers: false
    secrets: inherit

  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: "Set up Go envs"
      shell: bash
      run: |
          echo "Setting up Go envs"
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global http.https://github.com/.extraheader "AUTHORIZATION: basic $(echo -n x-access-token:${{ secrets.SYS_ORCH_GITHUB }} | base64)"

    - name: Lint code
      run: make lint

  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: "Set up Go envs"
      shell: bash
      run: |
          echo "Setting up Go envs"
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global http.https://github.com/.extraheader "AUTHORIZATION: basic $(echo -n x-access-token:${{ secrets.SYS_ORCH_GITHUB }} | base64)"
  
    - name: Build code
      run: make build

  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: "Set up Go envs"
      shell: bash
      run: |
          echo "Setting up Go envs"
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global http.https://github.com/.extraheader "AUTHORIZATION: basic $(echo -n x-access-token:${{ secrets.SYS_ORCH_GITHUB }} | base64)"
  
    - name: Test code
      run: make test
  