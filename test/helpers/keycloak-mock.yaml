# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
apiVersion: v1
kind: Namespace
metadata:
  name: orch-platform
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mock-keycloak-config
  namespace: orch-platform
data:
  nginx.conf: |
    server {
        listen 80;
        server_name localhost;
        
        location / {
            root /usr/share/nginx/html;
            try_files $uri $uri/ =404;
            add_header Content-Type application/json;
        }

        location /realms/master/protocol/openid-connect/token {
            add_header Content-Type application/json;
            return 200 '{"access_token": "dummy-token-replaced-by-test", "token_type": "Bearer", "expires_in": 3600}';
        }

        location /realms/master/protocol/openid-connect/certs {
            add_header Content-Type application/json;
            alias /etc/keycloak-jwk/jwks.json;
        }
    }
  # Placeholder JWK - will be replaced by init container
  jwks.json: |
    {"keys":[{"kty":"RSA","kid":"test-key-2024","use":"sig","alg":"PS512","n":"placeholder","e":"AQAB"}]}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mock-keycloak-content
  namespace: orch-platform
data:
  "openid-configuration": |
    {
      "issuer": "http://platform-keycloak.orch-platform.svc/realms/master",
      "authorization_endpoint": "http://platform-keycloak.orch-platform.svc/realms/master/protocol/openid-connect/auth",
      "token_endpoint": "http://platform-keycloak.orch-platform.svc/realms/master/protocol/openid-connect/token",
      "jwks_uri": "http://platform-keycloak.orch-platform.svc/realms/master/protocol/openid-connect/certs",
      "response_types_supported": ["code"],
      "subject_types_supported": ["public"],
      "id_token_signing_alg_values_supported": ["PS512"],
      "grant_types_supported": ["client_credentials", "authorization_code"],
      "token_endpoint_auth_methods_supported": ["client_secret_basic", "client_secret_post"],
      "scopes_supported": ["openid", "profile", "email", "roles"]
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: platform-keycloak
  namespace: orch-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: platform-keycloak
  template:
    metadata:
      labels:
        app: platform-keycloak
    spec:
      containers:
      - name: mock-keycloak
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: config-volume
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: nginx.conf
        - name: content-volume
          mountPath: /usr/share/nginx/html/realms/master/.well-known
        - name: jwk-volume
          mountPath: /etc/keycloak-jwk/jwks.json
          subPath: jwks.json
      volumes:
      - name: config-volume
        configMap:
          name: mock-keycloak-config
      - name: content-volume
        configMap:
          name: mock-keycloak-content
      - name: jwk-volume
        configMap:
          name: mock-keycloak-config
          items:
          - key: jwks.json
            path: jwks.json
---
apiVersion: v1
kind: Service
metadata:
  name: platform-keycloak
  namespace: orch-platform
spec:
  selector:
    app: platform-keycloak
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
